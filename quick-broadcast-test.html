<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
        .container { max-width: 600px; margin: 0 auto; }
        .step { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #ddd; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical; }
        .result { background: white; padding: 15px; border-radius: 5px; margin: 10px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</h1>
        
        <div class="step">
            <h3>Ø®Ø·ÙˆØ© 1: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <p>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…</p>
            <button onclick="window.open('/', '_blank')">ÙØªØ­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</button>
        </div>
        
        <div class="step">
            <h3>Ø®Ø·ÙˆØ© 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©</h3>
            <button onclick="checkStatus()">ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <div id="status-result"></div>
        </div>
        
        <div class="step">
            <h3>Ø®Ø·ÙˆØ© 3: Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
            <textarea id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ...">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­

âœ… ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ù…Ø§Ø¹ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
ğŸ“± Ø´Ø±ÙƒØ© Ø§Ø´Ø±Ø§Ù‚ Ø§Ù„ÙˆØ¯Ù‚ Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª

Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ…</textarea>
            <br><br>
            <button onclick="sendBroadcast()" id="sendBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
            <div id="broadcast-result"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ“‹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø³Ø¬Ù„</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleString('ar-SA');
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        async function checkStatus() {
            log('ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...');
            
            try {
                // ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                const authResponse = await fetch('/api/auth/user', { credentials: 'include' });
                if (authResponse.ok) {
                    const user = await authResponse.json();
                    document.getElementById('status-result').innerHTML = `
                        <div class="success">
                            âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­<br>
                            Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.username}<br>
                            Ø§Ù„Ø¯ÙˆØ±: ${user.role}
                        </div>
                    `;
                    log(`ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­: ${user.username} (${user.role})`, 'success');
                    
                    // ÙØ­Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    const statsResponse = await fetch('/api/users/count', { credentials: 'include' });
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        document.getElementById('status-result').innerHTML += `
                            <div class="info">
                                ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:<br>
                                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${stats.totalUsers}<br>
                                Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: ${stats.activeUsers}
                            </div>
                        `;
                        log(`Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${stats.totalUsers} Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ ${stats.activeUsers} Ù†Ø´Ø·`, 'info');
                    }
                    
                } else {
                    document.getElementById('status-result').innerHTML = `
                        <div class="error">
                            âŒ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„<br>
                            ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£ÙˆÙ„Ø§Ù‹
                        </div>
                    `;
                    log('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
                }
                
            } catch (error) {
                document.getElementById('status-result').innerHTML = `
                    <div class="error">âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©: ${error.message}</div>
                `;
                log(`Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        async function sendBroadcast() {
            const message = document.getElementById('message').value.trim();
            if (!message) {
                log('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            log('Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©...');
            
            try {
                const response = await fetch('/api/whatsapp/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('broadcast-result').innerHTML = `
                        <div class="result success">
                            <h4>ğŸ‰ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­!</h4>
                            <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</strong> ${result.totalUsers}</p>
                            <p><strong>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­:</strong> ${result.successCount}</p>
                            <p><strong>ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:</strong> ${result.failedCount}</p>
                            ${result.failedCount > 0 ? `<p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ£Ø«Ø±ÙŠÙ†:</strong> ${result.failedUsers.join(', ')}</p>` : ''}
                        </div>
                    `;
                    log(`Ø¥Ø±Ø³Ø§Ù„ Ù†Ø§Ø¬Ø­: ${result.successCount} Ù†Ø¬Ø­ØŒ ${result.failedCount} ÙØ´Ù„`, 'success');
                } else {
                    const error = await response.text();
                    document.getElementById('broadcast-result').innerHTML = `
                        <div class="result error">âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${error}</div>
                    `;
                    log(`ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${error}`, 'error');
                }
                
            } catch (error) {
                document.getElementById('broadcast-result').innerHTML = `
                    <div class="result error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${error.message}</div>
                `;
                log(`Ø®Ø·Ø£: ${error.message}`, 'error');
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹';
            }
        }

        // ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            log('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        });
    </script>
</body>
</html>