<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <title>اختبار سريع للإرسال الجماعي</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
        .container { max-width: 600px; margin: 0 auto; }
        .step { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #ddd; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical; }
        .result { background: white; padding: 15px; border-radius: 5px; margin: 10px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 اختبار سريع للإرسال الجماعي</h1>
        
        <div class="step">
            <h3>خطوة 1: تسجيل الدخول</h3>
            <p>يجب تسجيل الدخول أولاً من الواجهة الرئيسية للنظام</p>
            <button onclick="window.open('/', '_blank')">فتح النظام الرئيسي</button>
        </div>
        
        <div class="step">
            <h3>خطوة 2: التحقق من الحالة</h3>
            <button onclick="checkStatus()">فحص حالة النظام</button>
            <div id="status-result"></div>
        </div>
        
        <div class="step">
            <h3>خطوة 3: إرسال رسالة جماعية</h3>
            <textarea id="message" placeholder="اكتب رسالة للإرسال الجماعي...">🎉 مبروك! تم تفعيل نظام الرسائل الجماعية بنجاح

✅ يمكن الآن إرسال رسائل واتساب جماعية لجميع المستخدمين في النظام
📱 شركة اشراق الودق لتكنولوجيا المعلومات

شكراً لكم</textarea>
            <br><br>
            <button onclick="sendBroadcast()" id="sendBtn">📤 إرسال الرسالة للجميع</button>
            <div id="broadcast-result"></div>
        </div>
        
        <div class="step">
            <h3>📋 النتائج والسجل</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleString('ar-SA');
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        async function checkStatus() {
            log('فحص حالة النظام...');
            
            try {
                // فحص المصادقة
                const authResponse = await fetch('/api/auth/user', { credentials: 'include' });
                if (authResponse.ok) {
                    const user = await authResponse.json();
                    document.getElementById('status-result').innerHTML = `
                        <div class="success">
                            ✅ تم تسجيل الدخول بنجاح<br>
                            المستخدم: ${user.username}<br>
                            الدور: ${user.role}
                        </div>
                    `;
                    log(`تسجيل دخول ناجح: ${user.username} (${user.role})`, 'success');
                    
                    // فحص الإحصائيات
                    const statsResponse = await fetch('/api/users/count', { credentials: 'include' });
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        document.getElementById('status-result').innerHTML += `
                            <div class="info">
                                📊 إحصائيات المستخدمين:<br>
                                إجمالي المستخدمين: ${stats.totalUsers}<br>
                                المستخدمين النشطين: ${stats.activeUsers}
                            </div>
                        `;
                        log(`إحصائيات: ${stats.totalUsers} إجمالي، ${stats.activeUsers} نشط`, 'info');
                    }
                    
                } else {
                    document.getElementById('status-result').innerHTML = `
                        <div class="error">
                            ❌ لم يتم تسجيل الدخول<br>
                            يرجى تسجيل الدخول من النظام الرئيسي أولاً
                        </div>
                    `;
                    log('لم يتم تسجيل الدخول', 'error');
                }
                
            } catch (error) {
                document.getElementById('status-result').innerHTML = `
                    <div class="error">❌ خطأ في فحص الحالة: ${error.message}</div>
                `;
                log(`خطأ: ${error.message}`, 'error');
            }
        }

        async function sendBroadcast() {
            const message = document.getElementById('message').value.trim();
            if (!message) {
                log('يرجى كتابة رسالة أولاً', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '📤 جاري الإرسال...';
            
            log('إرسال رسالة جماعية...');
            
            try {
                const response = await fetch('/api/whatsapp/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('broadcast-result').innerHTML = `
                        <div class="result success">
                            <h4>🎉 تم الإرسال الجماعي بنجاح!</h4>
                            <p><strong>إجمالي المستخدمين:</strong> ${result.totalUsers}</p>
                            <p><strong>تم الإرسال بنجاح:</strong> ${result.successCount}</p>
                            <p><strong>فشل في الإرسال:</strong> ${result.failedCount}</p>
                            ${result.failedCount > 0 ? `<p><strong>المستخدمين المتأثرين:</strong> ${result.failedUsers.join(', ')}</p>` : ''}
                        </div>
                    `;
                    log(`إرسال ناجح: ${result.successCount} نجح، ${result.failedCount} فشل`, 'success');
                } else {
                    const error = await response.text();
                    document.getElementById('broadcast-result').innerHTML = `
                        <div class="result error">❌ فشل الإرسال: ${error}</div>
                    `;
                    log(`فشل الإرسال: ${error}`, 'error');
                }
                
            } catch (error) {
                document.getElementById('broadcast-result').innerHTML = `
                    <div class="result error">❌ خطأ في الإرسال: ${error.message}</div>
                `;
                log(`خطأ: ${error.message}`, 'error');
                
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '📤 إرسال الرسالة للجميع';
            }
        }

        // تشغيل فحص الحالة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            log('تم تحميل صفحة الاختبار');
        });
    </script>
</body>
</html>