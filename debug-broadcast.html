<!DOCTYPE html>
<html>
<head>
    <title>Debug Broadcast - ุชุตุญูุญ ุงูุฅุฑุณุงู ุงูุฌูุงุนู</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
            direction: rtl;
        }
        .debug-section { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { 
            background: #007bff; 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 4px; 
            margin: 5px; 
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .broadcast-btn { background: #28a745; }
        .broadcast-btn:hover { background: #218838; }
        textarea { 
            width: 100%; 
            height: 80px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            resize: vertical;
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>๐ง ุชุตุญูุญ ูุธุงู ุงูุฅุฑุณุงู ุงูุฌูุงุนู</h1>
    
    <div class="debug-section">
        <h3>1. ุงุฎุชุจุงุฑ ุงูุงุชุตุงู</h3>
        <button onclick="testConnection()">ุงุฎุชุจุงุฑ ุงูุงุชุตุงู</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. ุชุณุฌูู ุงูุฏุฎูู</h3>
        <button onclick="testLogin()">ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ</button>
        <div id="login-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. ุงุฎุชุจุงุฑ ุงูุฅุญุตุงุฆูุงุช</h3>
        <button onclick="testStats()">ุฌูุจ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู</button>
        <div id="stats-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. ุงุฎุชุจุงุฑ ุงูุฅุฑุณุงู ุงูุฌูุงุนู</h3>
        <textarea id="testMessage" placeholder="ุงูุชุจ ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ...">ุงูุณูุงู ุนูููู
ูุฐู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ ูู ูุธุงู ุฅุฏุงุฑุฉ ุงูููุงู
ุดุฑูุฉ ุงุดุฑุงู ุงููุฏู ูุชูููููุฌูุง ุงููุนูููุงุช</textarea>
        <br>
        <button class="broadcast-btn" onclick="testBroadcast()">ุฅุฑุณุงู ุฑุณุงูุฉ ุฌูุงุนูุฉ</button>
        <div id="broadcast-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>๐ ุณุฌู ุงูุชุตุญูุญ</h3>
        <button onclick="clearLog()">ูุณุญ ุงูุณุฌู</button>
        <pre id="debug-log"></pre>
    </div>

    <script>
        let sessionCookie = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debug-log');
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `debug-section ${type}`;
            element.innerHTML = message;
        }
        
        async function testConnection() {
            log('ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ูุน ุงูุฎุงุฏู...');
            try {
                const response = await fetch('/api/ping');
                if (response.ok) {
                    showResult('connection-result', 'โ ุงูุงุชุตุงู ูุงุฌุญ - ุงูุฎุงุฏู ูุนูู ุจุดูู ุทุจูุนู', 'success');
                    log('ุงูุงุชุตุงู ูุงุฌุญ', 'success');
                } else {
                    showResult('connection-result', `โ ุฎุทุฃ ูู ุงูุงุชุตุงู - ุฑูุฒ ุงูุงุณุชุฌุงุจุฉ: ${response.status}`, 'error');
                    log(`ุฎุทุฃ ูู ุงูุงุชุตุงู: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('connection-result', `โ ูุดู ุงูุงุชุตุงู: ${error.message}`, 'error');
                log(`ูุดู ุงูุงุชุตุงู: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            log('ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู...');
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult('login-result', `โ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ\nุงููุณุชุฎุฏู: ${result.user.username}\nุงูุฏูุฑ: ${result.user.role}`, 'success');
                    log('ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ', 'success');
                } else {
                    const error = await response.text();
                    showResult('login-result', `โ ูุดู ุชุณุฌูู ุงูุฏุฎูู: ${error}`, 'error');
                    log(`ูุดู ุชุณุฌูู ุงูุฏุฎูู: ${error}`, 'error');
                }
            } catch (error) {
                showResult('login-result', `โ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: ${error.message}`, 'error');
                log(`ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: ${error.message}`, 'error');
            }
        }
        
        async function testStats() {
            log('ูุญุงููุฉ ุฌูุจ ุงูุฅุญุตุงุฆูุงุช...');
            try {
                const response = await fetch('/api/users/count', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    showResult('stats-result', 
                        `โ ุชู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ุจูุฌุงุญ\n` +
                        `ุฅุฌูุงูู ุงููุณุชุฎุฏููู: ${stats.totalUsers}\n` +
                        `ุงููุณุชุฎุฏููู ุงููุดุทูู: ${stats.activeUsers}`, 
                        'success'
                    );
                    log(`ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู: ${stats.totalUsers} ุฅุฌูุงููุ ${stats.activeUsers} ูุดุท`, 'success');
                } else {
                    const error = await response.text();
                    showResult('stats-result', `โ ูุดู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช: ${error}`, 'error');
                    log(`ูุดู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช: ${error}`, 'error');
                }
            } catch (error) {
                showResult('stats-result', `โ ุฎุทุฃ ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช: ${error.message}`, 'error');
                log(`ุฎุทุฃ ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช: ${error.message}`, 'error');
            }
        }
        
        async function testBroadcast() {
            const message = document.getElementById('testMessage').value.trim();
            if (!message) {
                showResult('broadcast-result', 'โ ูุฑุฌู ูุชุงุจุฉ ุฑุณุงูุฉ ููุงุฎุชุจุงุฑ', 'error');
                return;
            }
            
            log('ุฅุฑุณุงู ุฑุณุงูุฉ ุฌูุงุนูุฉ...');
            try {
                const response = await fetch('/api/whatsapp/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult('broadcast-result', 
                        `โ ุชู ุงูุฅุฑุณุงู ุงูุฌูุงุนู ุจูุฌุงุญ!\n` +
                        `ุฅุฌูุงูู ุงููุณุชุฎุฏููู: ${result.totalUsers}\n` +
                        `ุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ: ${result.successCount}\n` +
                        `ูุดู ุงูุฅุฑุณุงู: ${result.failedCount}\n` +
                        (result.failedCount > 0 ? `ุงููุณุชุฎุฏููู ุงููุชุฃุซุฑูู: ${result.failedUsers.join(', ')}` : ''),
                        'success'
                    );
                    log(`ุงูุฅุฑุณุงู ุงูุฌูุงุนู: ${result.successCount} ูุฌุญุ ${result.failedCount} ูุดู`, 'success');
                } else {
                    const error = await response.text();
                    showResult('broadcast-result', `โ ูุดู ุงูุฅุฑุณุงู ุงูุฌูุงุนู: ${error}`, 'error');
                    log(`ูุดู ุงูุฅุฑุณุงู ุงูุฌูุงุนู: ${error}`, 'error');
                }
            } catch (error) {
                showResult('broadcast-result', `โ ุฎุทุฃ ูู ุงูุฅุฑุณุงู ุงูุฌูุงุนู: ${error.message}`, 'error');
                log(`ุฎุทุฃ ูู ุงูุฅุฑุณุงู ุงูุฌูุงุนู: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
            log('ุชู ูุณุญ ุณุฌู ุงูุชุตุญูุญ');
        }
        
        // ุชุดุบูู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            log('ุชู ุชุญููู ุตูุญุฉ ุงูุชุตุญูุญ');
            testConnection();
        });
    </script>
</body>
</html>